/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint64m4_t data1[] = {
    183, 49, 148, 131, 59, 42, 130, 80, 73, 172, 56, 233, 105, 141, 158, 176, 109, 243, 187, 179, 202, 197, 50, 104, 127, 78, 185, 112, 54, 188, 226, 162, 103, 36, 122, 98, 143, 65, 151, 44, 204, 68, 75, 216, 251, 178, 78, 153, 34, 144, 5, 187, 12, 61, 147, 20, 100, 164, 166, 253, 176, 118, 99, 61
    };
    const vint64m4_t *in1 = &data1[0];
    vint64m4_t data2[] = {
    217, 43, 34, 234, 255, 85, 91, 36, 70, 243, 171, 193, 175, 72, 31, 237, 229, 92, 165, 11, 132, 205, 89, 42, 95, 232, 128, 230, 131, 7, 5, 132, 217, 10, 85, 7, 13, 49, 57, 220, 177, 230, 186, 79, 111, 7, 210, 179, 57, 208, 229, 190, 145, 77, 217, 56, 92, 206, 205, 234, 148, 165, 251, 8
    };
    const vint64m4_t *in2 = &data2[0];
    vint64m4_t out_data[] = {
    186, 189, 159, 134, 233, 218, 163, 32, 161, 140, 70, 31, 174, 135, 216, 28, 41, 1, 220, 145, 232, 249, 41, 43, 178, 24, 99, 230, 70, 18, 39, 240, 70, 119, 62, 197, 200, 163, 26, 145, 181, 224, 107, 38, 228, 7, 149, 106, 169, 219, 141, 149, 232, 168, 0, 191, 221, 150, 208, 27, 208, 237, 183, 38
    };
    vint64m4_t *out = &out_data[0];
    int masked[] = {
    0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint64m4_t out = __riscv_vadd_vx_i64m4_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint64m4_t golden[] = {
    186, 92, 182, 365, 233, 218, 221, 116, 161, 415, 227, 426, 174, 135, 189, 28, 41, 1, 220, 190, 232, 249, 41, 43, 222, 24, 313, 342, 70, 195, 231, 294, 320, 46, 62, 105, 156, 163, 26, 145, 181, 224, 261, 295, 228, 185, 288, 332, 169, 219, 234, 149, 157, 168, 0, 76, 221, 150, 371, 487, 208, 283, 183, 69
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
