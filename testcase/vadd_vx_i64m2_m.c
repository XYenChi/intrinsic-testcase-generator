/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint64m2_t data1[] = {
    169, 97, 189, 36, 109, 123, 6, 34, 197, 55, 19, 115, 228, 196, 69, 136, 84, 28, 46, 176, 164, 214, 152, 222, 198, 188, 182, 173, 67, 149, 244, 182, 43, 236, 4, 94, 11, 45, 28, 255, 109, 155, 118, 127, 77, 62, 235, 41, 254, 142, 213, 236, 173, 232, 246, 140, 22, 219, 91, 104, 117, 117, 63, 156
    };
    const vint64m2_t *in1 = &data1[0];
    vint64m2_t data2[] = {
    7, 204, 78, 161, 88, 94, 80, 156, 176, 213, 18, 141, 186, 78, 39, 83, 210, 176, 218, 84, 151, 86, 109, 203, 160, 43, 255, 252, 188, 236, 183, 33, 209, 45, 51, 3, 78, 87, 38, 179, 23, 186, 143, 133, 102, 11, 85, 199, 217, 175, 149, 37, 26, 88, 70, 195, 162, 124, 247, 234, 195, 48, 1, 236
    };
    const vint64m2_t *in2 = &data2[0];
    vint64m2_t out_data[] = {
    138, 69, 246, 57, 144, 158, 248, 254, 102, 96, 156, 228, 218, 222, 130, 21, 49, 126, 204, 140, 184, 243, 130, 130, 198, 31, 46, 184, 251, 26, 171, 7, 186, 162, 90, 174, 150, 24, 17, 241, 214, 90, 85, 21, 125, 232, 162, 166, 36, 191, 188, 115, 248, 239, 5, 146, 107, 114, 83, 69, 197, 3, 170, 246
    };
    vint64m2_t *out = &out_data[0];
    int masked[] = {
    1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint64m2_t out = __riscv_vadd_vx_i64m2_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint64m2_t golden[] = {
    176, 69, 267, 197, 144, 158, 86, 190, 102, 96, 37, 256, 414, 222, 108, 219, 49, 126, 264, 140, 315, 243, 261, 130, 358, 31, 437, 425, 251, 385, 171, 7, 252, 162, 55, 174, 89, 132, 17, 434, 132, 90, 261, 260, 125, 232, 162, 166, 471, 191, 362, 115, 248, 320, 316, 146, 107, 114, 338, 338, 312, 165, 170, 246
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
