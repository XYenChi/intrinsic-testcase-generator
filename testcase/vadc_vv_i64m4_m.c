/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    13214943335000393947, 8915678530432013054, 6921493322225985180, 1072950341041785189, 3814326798052479076, 4933676777156342619, 15835836599949859048, 1747087961075329211, 13290369428783801640, 144240054507739061, 11444829241956353775, 13694892728406903368, 11961501772899009142, 16426440307105888628, 18176377151020661200, 10000143175285342536
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    16722574302363718393, 13281712470628379880, 4132261514944261972, 13637552899338444774, 17074869383519719933, 13731850928054561042, 13120764755463344847, 873970045368824024, 18144471807150683425, 9729082535774960693, 7972110896191181209, 6405966579515570356, 4231999910056359983, 7859729474670948363, 14349369553904289695, 16220830011125784296
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m4(size_t avl);
    const int out_data[] = {
    10965613341122594687, 17867812863967183977, 11946574515943038388, 8757374947557523184, 17410969617025276145, 17142603701723405599, 12317561169938989571, 14665247281146050874, 1945909265175163397, 7874262672099440077, 5272930831425368857, 17558673788360243116, 9914067099914127047, 503045319242377807, 11381134312326756118, 18388301432820224197
    };
    const int64_t *out = &out_data[0];
    bool16_t masked[] = {
    0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0
    };
    const bool16_t *mask = &masked[0];
    vint64m4_t data1_v = __riscv_vle64_v_i64m4_m (mask, *in1, vl);
    vint64m4_t data2_v = __riscv_vle64_v_i64m4_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        void vint16_t __riscv_vse64m4_v_i64 (vbool64_t mask, int64m4_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    29937517637364112340, 22197391001060392935, 11053754837170247153, 14710503240380229963, 20889196181572199009, 18665527705210903662, 28956601355413203896, 2621058006444153236, 31434841235934485066, 9873322590282699754, 19416940138147534984, 20100859307922473724, 16193501682955369125, 24286169781776836991, 32525746704924950895, 26220973186411126832
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
