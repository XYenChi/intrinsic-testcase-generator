/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint16m8_t data1[] = {
    8457, 23736, 30772, 63067, 40395, 53014, 31869, 46239, 62230, 61487, 44957, 47743, 54407, 32822, 39968, 39978, 12440, 17904, 20957, 33945, 25150, 49214, 64903, 37193, 6336, 16613, 62496, 26602, 913, 56483, 18961, 30134, 23113, 19866, 52940, 47285, 19682, 20586, 23206, 51986, 39784, 58154, 10060, 11259, 8019, 42866, 52605, 29950, 25454, 48227, 50946, 14507, 33199, 43398, 36338, 21243, 24633, 7923, 52244, 10696, 45893, 43821, 28856, 37808
    };
    const vint16m8_t *in1 = &data1[0];
    vint16m8_t data2[] = {
    27419, 23184, 20702, 25646, 35217, 1967, 21075, 23078, 9668, 29489, 26370, 8997, 45102, 48012, 1673, 32510, 50496, 32162, 25037, 62001, 23171, 59356, 24182, 60090, 47903, 14666, 6987, 21173, 37461, 5298, 10751, 17876, 31614, 31615, 56726, 33766, 44461, 18573, 20485, 59143, 55356, 28791, 21741, 7440, 4513, 20541, 5664, 16865, 18802, 32728, 7156, 26319, 56214, 55182, 54540, 41480, 44266, 64933, 44290, 28580, 31593, 13166, 53275, 17796
    };
    const vint16m8_t *in2 = &data2[0];
    vint16m8_t out_data[] = {
    23672, 56898, 63939, 34094, 59571, 8361, 54217, 7951, 21386, 60847, 18956, 21886, 48711, 5210, 58556, 9179, 27677, 47286, 36502, 46118, 3023, 17929, 42130, 52098, 50617, 25505, 56570, 42972, 16700, 36186, 42081, 49051, 24230, 5268, 61090, 17283, 1503, 5739, 56722, 64944, 17392, 10989, 8010, 23728, 32196, 20287, 57915, 40762, 60210, 17073, 32311, 61258, 62346, 14620, 49014, 46948, 4217, 431, 10864, 20451, 41879, 24944, 40347, 65459
    };
    vint16m8_t *out = &out_data[0];
    int masked[] = {
    1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 16;n >= 0; n -= Q_element) {
        vint16m8_t out = __riscv_vadd_vx_i16m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint16m8_t golden[] = {
    35876, 46920, 63939, 34094, 75612, 54981, 52944, 7951, 71898, 90976, 71327, 21886, 99509, 5210, 58556, 9179, 27677, 50066, 36502, 95946, 3023, 108570, 89085, 97283, 54239, 31279, 56570, 42972, 38374, 61781, 29712, 48010, 54727, 51481, 109666, 17283, 1503, 39159, 56722, 111129, 95140, 10989, 8010, 23728, 32196, 63407, 57915, 40762, 60210, 17073, 32311, 40826, 62346, 14620, 90878, 62723, 4217, 72856, 10864, 39276, 41879, 24944, 82131, 65459
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
