/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    16824931760932405985, 17395051675110907863, 8684619703621377322, 16092148412078214760, 10338247467742880927, 2078675918854074171, 2879661018106881148, 6227834551201929462, 14736967847732124870, 4143337002734969777, 183085104516517019, 11114278386150298904, 1412077405658047785, 10255808502864835528, 14156478215341371907, 10839786455002315858
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    8604402963517318742, 14433000932360073038, 4669953289379093187, 13639834852970359057, 6886746840103344223, 18418223503735514856, 10026236187742478281, 1706345166250520406, 6401032724900821117, 13863818114676118123, 4945500239551537775, 3750030548528459845, 15563626347122091992, 6353343697236928365, 929748344666295364, 11208954512677802726
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m2(size_t avl);
    const int out_data[] = {
    1177637378732157907, 14305956058031810914, 11533296656961744723, 14907830590386900926, 14208487798272984340, 7596290502679368170, 18195454749494272849, 16007142796125457197, 9540345571931095709, 15562480906348973854, 5419699471828412527, 12224204537679429322, 1945020690312024280, 6312222610001035130, 1478281507768195294, 2690160632103067841
    };
    const int64_t *out = &out_data[0];
    bool32_t masked[] = {
    1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1
    };
    const bool32_t *mask = &masked[0];
    vint64m2_t data1_v = __riscv_vle64_v_i64m2_m (mask, *in1, vl);
    vint64m2_t data2_v = __riscv_vle64_v_i64m2_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        void vint32_t __riscv_vse64m2_v_i64 (vbool64_t mask, int64m2_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    25429334724449724728, 31828052607470980902, 13354572993000470510, 29731983265048573817, 17224994307846225150, 20496899422589589027, 12905897205849359430, 7934179717452449869, 21138000572632945987, 18007155117411087900, 5128585344068054794, 14864308934678758750, 16975703752780139777, 16609152200101763894, 15086226560007667271, 22048740967680118585
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
