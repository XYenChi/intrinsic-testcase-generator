/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    16019650032563342486, 7435849564319010511, 18400328130884098004, 4563741933986142540, 7711841652725483168, 17448004269109765417, 10978569100022083551, 2436272978283590330, 17198368436024960595, 13699217156345273556, 11203617346609945184, 7279252111590139638, 8679347951150927641, 2211620178924729588, 4520601398660775717, 2469659468610920396
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    6976606818414351790, 18027318774492180973, 7759427074345845466, 13516724544638218814, 3766685287953049086, 8793409747801269232, 13432915115390998246, 15724030399653575375, 2600981296329344146, 2822139068626702896, 13174815745745991858, 15778697229053225142, 3078612648462888632, 10467181033084150482, 3330569428352283758, 5705260072278706756
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m4(size_t avl);
    const int out_data[] = {
    1883103002135266961, 9595860920566403302, 6604251431048970038, 13962570043523301069, 17724526871181854920, 8528155761672404462, 7530746525180972153, 7752169906687680359, 17067917204581319871, 2016554264520465932, 16050953642207256824, 18211081540600081536, 12286800745593194957, 13615767486828953977, 4806276915034345141, 1646179106421717501
    };
    const int64_t *out = &out_data[0];
    bool16_t masked[] = {
    0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1
    };
    const bool16_t *mask = &masked[0];
    vint64m4_t data1_v = __riscv_vle64_v_i64m4_m (mask, *in1, vl);
    vint64m4_t data2_v = __riscv_vle64_v_i64m4_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmacc_vx_i64m4_m (mask, data1_v, data2_v, vl);
        void vint16_t __riscv_vse64m4_v_i64 (vbool64_t mask, int64m4_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    30166651069476357366729137350083405046, 71353378245459509121979679054803107323, 121520393390161924305843106976851604152, 63721566413846008438827005042368375261, 136688744600032313144483267851477986560, 148799298137293156205891572371164090655, 82676821101450498411843179082770355303, 18886402066726417566186667581943328470, 293540328519958751633463078225865483245, 27625214777219991870545875299118494192, 179828742655465302153114844533649935616, 132563053758753356795658336916425523969, 106641418877463986781550905167513106437, 30112906125418166908565681943622171477, 21727262144455258937051474608169741097, 4065501817203858618748031266711050397
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
