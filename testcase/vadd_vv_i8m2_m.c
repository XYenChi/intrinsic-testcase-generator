/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m2_t data1[] = {
    137, 98, 17, 167, 239, 113, 77, 96, 96, 196, 203, 35, 194, 79, 188, 74, 201, 36, 240, 51, 152, 190, 73, 31, 249, 89, 231, 119, 74, 58, 121, 16, 172, 152, 216, 136, 244, 106, 183, 47, 49, 35, 21, 20, 1, 103, 69, 42, 212, 162, 101, 83, 248, 12, 25, 76, 5, 253, 232, 108, 221, 184, 214, 42
    };
    const vint8m2_t *in1 = &data1[0];
    vint8m2_t data2[] = {
    209, 125, 33, 234, 188, 67, 224, 111, 132, 71, 225, 106, 109, 38, 79, 17, 51, 76, 179, 226, 44, 93, 127, 56, 253, 87, 72, 179, 98, 122, 166, 32, 14, 239, 0, 2, 45, 200, 169, 29, 143, 58, 20, 208, 110, 73, 148, 239, 216, 204, 250, 232, 117, 145, 144, 212, 45, 244, 22, 246, 199, 84, 126, 62
    };
    const vint8m2_t *in2 = &data2[0];
    vint8m2_t out_data[] = {
    55, 28, 8, 66, 28, 7, 75, 17, 36, 179, 154, 216, 150, 210, 216, 63, 168, 125, 51, 39, 241, 21, 172, 140, 18, 83, 110, 233, 122, 209, 225, 102, 145, 178, 179, 210, 74, 120, 102, 208, 4, 46, 55, 35, 56, 52, 90, 147, 86, 105, 56, 205, 42, 196, 141, 153, 31, 30, 216, 244, 5, 224, 80, 138
    };
    vint8m2_t *out = &out_data[0];
    int masked[] = {
    0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint8m2_t out = __riscv_vadd_vv_i8m2_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m2_t golden[] = {
    55, 28, 8, 401, 28, 180, 301, 17, 36, 179, 154, 216, 303, 117, 267, 91, 252, 112, 51, 39, 241, 21, 172, 140, 502, 176, 303, 233, 122, 180, 225, 48, 186, 178, 179, 138, 289, 306, 102, 76, 192, 93, 41, 35, 56, 52, 217, 147, 86, 105, 56, 205, 365, 196, 141, 288, 50, 497, 254, 354, 420, 268, 340, 104
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
