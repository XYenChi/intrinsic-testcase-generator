/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    288229345480455406, 7992247208873474475, 3414096854838345140, 2823509862824504758, 9652152714925753314, 211280090842022729, 9460800055730790310, 8016372242779101143, 3897351940833814133, 13222399881647555369, 4278576921710512810, 7495475294968575321, 18000173661701396713, 3810042856020288874, 5518355758008077190, 2077215900650892913
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    16119669166087587265, 8499326138541014744, 4669207430992863112, 5441530949202794083, 17689346034665620141, 10757981924793485431, 10733913606929297684, 79962385888355252, 4123245112020530261, 8309875826925120252, 8254130099938018528, 4209072435030260044, 16750836304911984385, 10736797221824226710, 11840533360540687751, 5729140449440916931
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m2(size_t avl);
    const int out_data[] = {
    7017891131042382522, 10860607732830558949, 51445610661855019, 561200938214962896, 10364090709439115770, 7297940213722983032, 5727356370695584906, 15898700368992170362, 2020720433795896132, 6901054028762621120, 12852399464937500888, 4879811907412559773, 8288344131260023001, 10336660717973622249, 4116591127053507409, 9703500828255277634
    };
    const int64_t *out = &out_data[0];
    bool32_t masked[] = {
    0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1
    };
    const bool32_t *mask = &masked[0];
    vint64m2_t data1_v = __riscv_vle64_v_i64m2_m (mask, *in1, vl);
    vint64m2_t data2_v = __riscv_vle64_v_i64m2_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmacc_vx_i64m2_m (mask, data1_v, data2_v, vl);
        void vint32_t __riscv_vse64m2_v_i64 (vbool64_t mask, int64m2_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    2022762167353438814184275187814813932, 86800661839384708334839777133934326776, 175640297555877255844708564563257661, 1584556384076313256572381286545459169, 100035786278849538018025572285307161780, 1541909471315042624907302302625334329, 54185373471066886604563071239087060861, 127449900334250687634968213291084923767, 7875458704536982610629605112261633556, 91248495973154266662420402452768793280, 54989979739286134465889046078310375280, 36576509596104322628461490623565162134, 149191633730624010094732997342205795713, 39383120323620949453132819501133557627, 22716814349340682673236336341508900710, 20156266212430971880660170966818007843
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
