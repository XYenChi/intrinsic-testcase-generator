/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m8_t data1[] = {
    48, 76, 95, 6, 213, 167, 94, 146, 113, 251, 106, 253, 86, 34, 75, 84, 90, 3, 217, 48, 163, 35, 235, 185, 116, 4, 72, 152, 28, 163, 38, 244, 2, 252, 3, 86, 171, 204, 184, 172, 254, 181, 137, 63, 210, 168, 58, 235, 101, 256, 73, 11, 248, 205, 232, 238, 2, 127, 13, 154, 131, 131, 91, 198, 83, 60, 9, 79, 90, 255, 205, 58, 124, 227, 78, 193, 77, 76, 94, 161, 59, 123, 190, 214, 33, 158, 212, 30, 95, 198, 114, 180, 191, 2, 128, 175, 124, 155, 185, 244, 255, 34, 189, 57, 67, 210, 73, 142, 74, 180, 239, 118, 27, 96, 75, 7, 237, 5, 156, 28, 192, 199, 83, 111, 190, 237, 70, 2
    };
    const vint8m8_t *in1 = &data1[0];
    vint8m8_t data2[] = {
    251, 192, 22, 196, 156, 149, 47, 182, 52, 31, 111, 137, 113, 162, 11, 87, 175, 220, 120, 120, 47, 0, 112, 170, 43, 205, 124, 206, 169, 157, 8, 54, 86, 184, 196, 189, 74, 219, 190, 170, 136, 145, 192, 171, 149, 223, 89, 8, 230, 135, 167, 224, 143, 171, 113, 147, 122, 82, 40, 223, 166, 65, 239, 248, 119, 243, 240, 114, 47, 247, 176, 208, 179, 111, 8, 115, 248, 207, 73, 155, 3, 73, 187, 240, 70, 44, 29, 247, 189, 18, 22, 192, 112, 9, 181, 244, 240, 93, 120, 67, 41, 150, 90, 30, 104, 169, 37, 25, 179, 169, 53, 44, 135, 44, 91, 191, 62, 247, 46, 11, 202, 195, 202, 146, 75, 23, 224, 161
    };
    const vint8m8_t *in2 = &data2[0];
    vint8m8_t out_data[] = {
    150, 57, 10, 113, 238, 106, 74, 26, 224, 204, 37, 115, 204, 138, 196, 256, 75, 54, 167, 124, 243, 17, 31, 49, 58, 187, 95, 148, 74, 155, 30, 224, 167, 149, 20, 62, 83, 79, 222, 107, 159, 11, 211, 114, 88, 95, 84, 84, 16, 178, 212, 122, 210, 156, 50, 157, 211, 76, 113, 31, 225, 8, 45, 50, 50, 200, 136, 247, 76, 196, 88, 228, 202, 47, 67, 107, 9, 182, 0, 241, 154, 171, 27, 111, 187, 196, 22, 16, 175, 222, 5, 231, 29, 228, 27, 126, 236, 9, 84, 121, 70, 184, 138, 17, 115, 183, 144, 207, 200, 118, 155, 48, 140, 149, 79, 174, 138, 105, 128, 3, 195, 176, 123, 188, 52, 80, 254, 23
    };
    vint8m8_t *out = &out_data[0];
    int masked[] = {
    0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 128, Q_element = 8;n >= 0; n -= Q_element) {
        vint8m8_t out = __riscv_vadd_vx_i8m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m8_t golden[] = {
    150, 57, 10, 113, 238, 316, 74, 26, 224, 204, 217, 115, 204, 196, 196, 256, 75, 223, 167, 168, 210, 35, 31, 355, 159, 209, 95, 148, 197, 320, 30, 224, 88, 436, 199, 62, 83, 423, 374, 342, 390, 326, 211, 234, 88, 391, 84, 84, 16, 178, 240, 122, 210, 156, 345, 157, 124, 76, 113, 377, 225, 8, 45, 50, 202, 200, 136, 247, 137, 196, 381, 266, 303, 338, 67, 107, 9, 283, 0, 316, 154, 171, 27, 111, 187, 202, 241, 16, 284, 222, 136, 372, 303, 11, 27, 126, 364, 9, 84, 121, 70, 184, 138, 17, 171, 379, 144, 207, 253, 349, 155, 162, 162, 140, 79, 174, 138, 105, 202, 3, 394, 394, 123, 188, 265, 80, 294, 23
    };
    int fail = 0;
    for (int i = 0; i < 128; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
