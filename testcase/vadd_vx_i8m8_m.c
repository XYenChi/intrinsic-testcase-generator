/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m8_t data1[] = {
    245, 202, 226, 143, 207, 254, 198, 213, 159, 255, 140, 88, 205, 28, 32, 242, 4, 162, 226, 32, 9, 33, 247, 140, 24, 36, 108, 205, 133, 255, 62, 238, 141, 111, 5, 62, 103, 129, 230, 200, 177, 61, 64, 60, 151, 224, 47, 205, 118, 129, 27, 250, 113, 151, 77, 132, 67, 91, 252, 25, 0, 110, 44, 203
    };
    const vint8m8_t *in1 = &data1[0];
    vint8m8_t data2[] = {
    34, 212, 58, 30, 144, 233, 149, 236, 81, 241, 203, 92, 176, 24, 99, 42, 132, 79, 72, 244, 131, 146, 116, 156, 142, 121, 105, 82, 115, 59, 11, 172, 29, 130, 172, 47, 201, 72, 130, 87, 193, 137, 209, 122, 7, 68, 235, 20, 142, 203, 198, 150, 231, 254, 184, 153, 103, 238, 140, 0, 221, 11, 171, 178
    };
    const vint8m8_t *in2 = &data2[0];
    vint8m8_t out_data[] = {
    233, 206, 215, 78, 87, 92, 234, 52, 243, 248, 108, 114, 141, 162, 92, 119, 195, 40, 145, 112, 156, 230, 195, 138, 217, 218, 130, 186, 69, 229, 122, 245, 83, 130, 184, 222, 224, 196, 59, 234, 244, 197, 37, 243, 180, 230, 17, 127, 231, 144, 55, 59, 184, 89, 60, 131, 37, 96, 40, 238, 171, 188, 118, 1
    };
    vint8m8_t *out = &out_data[0];
    int masked[] = {
    1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint8m8_t out = __riscv_vadd_vx_i8m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m8_t golden[] = {
    279, 206, 284, 173, 351, 487, 234, 449, 240, 496, 108, 180, 381, 162, 131, 119, 195, 241, 145, 112, 156, 179, 195, 296, 217, 218, 213, 287, 248, 314, 73, 410, 170, 130, 177, 109, 304, 201, 360, 287, 370, 198, 37, 243, 158, 292, 282, 225, 260, 332, 225, 400, 184, 405, 261, 131, 170, 96, 392, 25, 171, 188, 118, 1
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
