/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint32m8_t data1[] = {
    63, 221, 82, 55, 29, 120, 41, 124, 244, 37, 14, 41, 72, 82, 4, 70, 144, 141, 3, 156, 215, 214, 219, 110, 180, 65, 151, 204, 58, 147, 230, 150, 254, 232, 88, 66, 65, 55, 130, 153, 57, 82, 242, 49, 196, 218, 127, 144, 195, 238, 10, 136, 7, 195, 164, 84, 194, 129, 240, 107, 199, 51, 3, 90
    };
    const vint32m8_t *in1 = &data1[0];
    vint32m8_t data2[] = {
    172, 151, 90, 85, 46, 0, 171, 175, 67, 173, 25, 24, 100, 105, 182, 128, 240, 117, 146, 4, 229, 208, 205, 12, 10, 114, 249, 136, 42, 58, 17, 94, 251, 194, 80, 150, 54, 86, 221, 146, 115, 207, 89, 112, 231, 55, 234, 220, 22, 172, 49, 51, 146, 18, 37, 43, 69, 16, 135, 24, 4, 149, 159, 62
    };
    const vint32m8_t *in2 = &data2[0];
    vint32m8_t out_data[] = {
    63, 165, 125, 146, 202, 60, 122, 235, 17, 203, 16, 86, 240, 8, 255, 116, 130, 88, 71, 167, 84, 66, 121, 221, 206, 14, 206, 80, 163, 135, 223, 112, 64, 76, 190, 123, 228, 252, 181, 160, 145, 30, 218, 7, 31, 67, 181, 44, 70, 255, 154, 106, 211, 107, 227, 142, 51, 185, 154, 82, 106, 160, 115, 59
    };
    vint32m8_t *out = &out_data[0];
    int masked[] = {
    1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint32m8_t out = __riscv_vadd_vv_i32m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint32m8_t golden[] = {
    235, 165, 125, 140, 202, 60, 212, 299, 311, 210, 16, 65, 240, 8, 255, 116, 384, 258, 149, 160, 84, 422, 424, 221, 190, 14, 400, 340, 163, 205, 247, 244, 64, 76, 190, 216, 228, 252, 181, 299, 145, 289, 331, 161, 427, 67, 181, 44, 70, 410, 59, 106, 211, 107, 201, 127, 263, 145, 154, 131, 203, 160, 162, 59
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
