/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    8582575265031566926, 1874748160074170098, 6347761235138305514, 871798444479191368, 6430810716257444903, 12117487503067573589, 15700390798815666708, 13823616205199662384, 4569481483900531755, 12642172942432267809, 7922493544412490931, 5308446889323563191, 12627935404581722146, 6986929137354762147, 13819106576624213792, 11235921402784071482
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    3285328217420391156, 7887884530640547850, 1688019217300309152, 753502100414267185, 7670672946258162922, 1271570033808561740, 3393613447649272884, 13678550711186321789, 11981088610552815577, 10717905025752641933, 17180690479435579163, 7407165370388072157, 5329484451659959581, 13900335052407241771, 9818704547185998417, 128003131851042209
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m4(size_t avl);
    const int out_data[] = {
    6154954716843701744, 9699029790565889707, 11043610641755362731, 16971587397701899120, 8873790849389338786, 13204931730958658147, 16183187254342091017, 3930882154932449313, 3316786409413371315, 52636837678026498, 2761151137426233301, 14436259426228728434, 7869731934397725231, 2467413746158808675, 5808444734242394537, 9882618849744816777
    };
    const int64_t *out = &out_data[0];
    bool16_t masked[] = {
    1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0
    };
    const bool16_t *mask = &masked[0];
    vint64m4_t data1_v = __riscv_vle64_v_i64m4_m (mask, *in1, vl);
    vint64m4_t data2_v = __riscv_vle64_v_i64m4_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmul_vx_i64m4_m (mask, data1_v, data2_v, vl);
        void vint16_t __riscv_vse64m4_v_i64 (vbool64_t mask, int64m4_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    28196576696342498954835377738512506456, 9699029790565889707, 11043610641755362731, 656901959052961589571646199097659080, 49328645783703061873865629118412486566, 15408233993950458929703231075699884860, 53281057348209756228413134183885945872, 3930882154932449313, 3316786409413371315, 52636837678026498, 2761151137426233301, 39320543969141780428041631108457172987, 7869731934397725231, 2467413746158808675, 5808444734242394537, 9882618849744816777
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
