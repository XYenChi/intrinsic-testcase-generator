/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    10890460229709778959, 6445308686268727219, 7915736186278268514, 4696782574250642324, 8634748589440437951, 8538488990276696687, 6399203801976439721, 1999445342362014544, 5205995160806820629, 5668915621911660874, 2699729904813917075, 12489832584836068536, 13942044269932159065, 12075225471098615440, 9278841791760267895, 2532617092591105036
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    387963309763372743, 680666140776813011, 8145762578429595678, 2859067412953068148, 12035493925100791606, 9132631900019742469, 1275791386298081377, 8113490186482199277, 5497973246966874185, 13556697049052468433, 2977592084975408553, 5074065918219244247, 18195205389947072509, 9338249189833272213, 2632898256402824595, 11478835664121638632
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m1(size_t avl);
    const int out_data[] = {
    18045055795868464736, 9964194643592295741, 8230773264865495492, 9703077102828721251, 7265444293676628984, 10347317829690949487, 13073540793994323780, 3201094842519722367, 9523958590798867748, 6478189008659236920, 6863768548724664383, 1454398952038659947, 18383201681517303842, 7137054129607567768, 10862152619134129462, 18336627136254971050
    };
    const int64_t *out = &out_data[0];
    bool64_t masked[] = {
    1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0
    };
    const bool64_t *mask = &masked[0];
    vint64m1_t data1_v = __riscv_vle64_v_i64m1_m (mask, *in1, vl);
    vint64m1_t data2_v = __riscv_vle64_v_i64m1_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmacc_vv_i64m1_m (mask, data1_v, data2_v, vl);
        void vint64_t __riscv_vse64m1_v_i64 (vbool64_t mask, int64m1_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    196518962487799458640585419945246289825, 64222310288017748298295360130304474279, 65152629773747530134329323352432538889, 45573243453176345873404457742298827325, 62735284866482351139682080302300171784, 88350459367709935860207164086937249570, 83660251954222559230770623767326865381, 6400414173335125319546893617696105649, 49581682335423452290366395768929173493, 36724306872884763895299400818660268081, 18530321210713195917803783046968039725, 18165199422523885436327209685290127593, 256299411666805557345837379228679627731, 86181537814446861279807286050771137920, 100788195670900012593327787770732222490, 46439655305749225194689758167689207800
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
