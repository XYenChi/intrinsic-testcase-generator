/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint32m8_t data1[] = {
    2162962673, 4237492717, 1038537377, 1165559126, 935293383, 3449956520, 3827623433, 3674783102, 3388414539, 514433142, 797070711, 1523111301, 2691472817, 2671680358, 3277037249, 2322186176, 3341787182, 158924166, 1147246519, 2189516025, 1705198129, 1595348502, 412565574, 3625577872, 24708524, 352773690, 2360546309, 201113279, 210303504, 4014305236, 2996714729, 4104659423
    };
    const vint32m8_t *in1 = &data1[0];
    vint32m8_t data2[] = {
    982272343, 4289828138, 1637871159, 1418009271, 3333813961, 3737599618, 4129781371, 1392266612, 2549712105, 415980980, 2191722760, 3461474181, 1714667077, 42392699, 980504469, 871332561, 664996473, 304941528, 4254087942, 2866549987, 4170340649, 3810842907, 3442398019, 3311098717, 801713144, 3102500912, 806140747, 1562182451, 1639649423, 2928509446, 3312652427, 2523046669
    };
    const vint32m8_t *in2 = &data2[0];
    vint32m8_t out_data[] = {
    4220593198, 527171325, 1251091521, 2707703765, 2617364400, 3439592938, 3137544936, 2382862308, 4093980366, 3603662377, 1400388674, 3748447235, 2114511155, 2998756652, 161893962, 212014876, 4103747979, 1570080029, 2406518831, 1479648563, 2501960738, 2836195319, 2467661872, 3161804822, 3902852688, 509126404, 3900303411, 1586066417, 1457217561, 2017440002, 1237719927, 803384947
    };
    vint32m8_t *out = &out_data[0];
    int masked[] = {
    0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1
    };
    const int *mask = &masked[0];
    for (int n = 32, Q_element = 32;n >= 0; n -= Q_element) {
        vint32m8_t out = __riscv_vadd_vx_i32m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint32m8_t golden[] = {
    4220593198, 527171325, 2676408536, 2707703765, 4269107344, 3439592938, 3137544936, 5067049714, 5938126644, 930414122, 2988793471, 3748447235, 4406139894, 2998756652, 4257541718, 212014876, 4103747979, 1570080029, 2406518831, 5056066012, 5875538778, 5406191409, 2467661872, 3161804822, 826421668, 3455274602, 3166687056, 1763295730, 1457217561, 6942814682, 1237719927, 6627706092
    };
    int fail = 0;
    for (int i = 0; i < 32; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
