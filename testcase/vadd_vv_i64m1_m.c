/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    15552772380514977026, 5940752809544780288, 10705053119706218379, 10201200316415275637, 1213195514057962543, 4166781960044329705, 16713326113998695338, 5759644019096417831, 10592733418063188708, 10119655270820083656, 17197987005718544513, 4864565308816860943, 3996188361585186029, 638261787465630253, 9381122448299065485, 4477931012575667367
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    12797152027164403569, 4025766543351383322, 1519584156006625030, 243131969433009847, 12509569826005343740, 3643508192525517239, 8121705315155182509, 11584511833079127872, 1531878075207347861, 7655016480576834071, 8485482091872229905, 17180920992688969000, 4758694785297123155, 13677625502458881386, 17032778142736447340, 8723494985922385981
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m1(size_t avl);
    const int out_data[] = {
    1729353109384930206, 2176583242496931255, 6632551817969751670, 475641764162666853, 9959990453900845393, 12515074681311454581, 12468554033166937179, 5723268342982595855, 10526105819781752548, 997126612644060411, 11906742485573843301, 9393280972071677091, 3211391719502083852, 6393283143040719135, 15269015806581268777, 17083195519672008742
    };
    const int64_t *out = &out_data[0];
    bool64_t masked[] = {
    0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0
    };
    const bool64_t *mask = &masked[0];
    vint64m1_t data1_v = __riscv_vle64_v_i64m1_m (mask, *in1, vl);
    vint64m1_t data2_v = __riscv_vle64_v_i64m1_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vadd_vv_i64m1_m (mask, data1_v, data2_v, vl);
        void vint64_t __riscv_vse64m1_v_i64 (vbool64_t mask, int64m1_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    1729353109384930206, 2176583242496931255, 12224637275712843409, 10444332285848285484, 13722765340063306283, 12515074681311454581, 12468554033166937179, 17344155852175545703, 10526105819781752548, 17774671751396917727, 25683469097590774418, 9393280972071677091, 3211391719502083852, 14315887289924511639, 26413900591035512825, 17083195519672008742
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
