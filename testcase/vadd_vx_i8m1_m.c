/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m1_t data1[] = {
    154, 148, 147, 101, 73, 177, 116, 238, 137, 6, 198, 32, 187, 182, 252, 18, 127, 161, 201, 110, 201, 224, 230, 110, 182, 172, 22, 103, 206, 218, 207, 159, 148, 57, 164, 52, 168, 38, 167, 123, 4, 183, 242, 119, 75, 47, 15, 19, 125, 168, 66, 242, 12, 195, 172, 214, 153, 70, 147, 18, 65, 160, 76, 16
    };
    const vint8m1_t *in1 = &data1[0];
    vint8m1_t data2[] = {
    24, 204, 43, 178, 0, 5, 180, 162, 167, 60, 109, 75, 14, 75, 5, 62, 18, 149, 124, 95, 160, 174, 27, 14, 39, 149, 163, 69, 33, 180, 9, 116, 254, 128, 108, 36, 221, 24, 101, 115, 50, 118, 219, 239, 14, 221, 242, 160, 245, 157, 40, 73, 7, 87, 21, 254, 82, 152, 67, 204, 235, 21, 155, 3
    };
    const vint8m1_t *in2 = &data2[0];
    vint8m1_t out_data[] = {
    105, 240, 215, 0, 24, 245, 38, 7, 89, 90, 25, 151, 26, 230, 75, 171, 117, 235, 78, 68, 2, 63, 251, 192, 19, 159, 63, 168, 35, 50, 47, 176, 152, 3, 184, 194, 212, 228, 10, 251, 85, 239, 20, 91, 11, 235, 149, 105, 236, 127, 196, 157, 104, 74, 192, 183, 9, 75, 220, 39, 147, 60, 72, 189
    };
    vint8m1_t *out = &out_data[0];
    int masked[] = {
    0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint8m1_t out = __riscv_vadd_vx_i8m1_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m1_t golden[] = {
    105, 352, 190, 0, 24, 182, 296, 400, 89, 90, 307, 107, 26, 257, 257, 80, 145, 235, 78, 68, 361, 398, 251, 192, 19, 159, 63, 172, 239, 398, 216, 275, 152, 3, 272, 194, 212, 228, 268, 238, 85, 301, 461, 91, 11, 235, 257, 179, 370, 325, 196, 315, 104, 282, 193, 183, 9, 75, 214, 39, 147, 60, 231, 189
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
