/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8mf4_t data1[] = {
    7, 156, 238, 41, 158, 104, 147, 173, 138, 124, 156, 22, 80, 219, 8, 5, 4, 223, 198, 18, 165, 237, 72, 192, 158, 254, 115, 231, 11, 189, 10, 53, 157, 180, 181, 151, 210, 134, 136, 60, 170, 68, 184, 139, 92, 63, 97, 148, 13, 51, 172, 238, 187, 232, 214, 117, 154, 197, 194, 48, 64, 193, 105, 209
    };
    const vint8mf4_t *in1 = &data1[0];
    vint8mf4_t data2[] = {
    171, 251, 188, 232, 132, 236, 140, 7, 204, 2, 244, 18, 200, 20, 162, 45, 138, 5, 210, 51, 26, 93, 189, 34, 150, 131, 193, 218, 1, 90, 13, 103, 152, 135, 134, 199, 90, 82, 93, 228, 237, 140, 151, 18, 255, 57, 239, 50, 223, 18, 126, 27, 149, 33, 169, 246, 45, 107, 121, 11, 68, 183, 114, 222
    };
    const vint8mf4_t *in2 = &data2[0];
    vint8mf4_t out_data[] = {
    15, 213, 99, 221, 37, 218, 196, 33, 37, 66, 202, 230, 88, 17, 129, 132, 35, 223, 163, 151, 91, 139, 163, 162, 218, 94, 170, 14, 179, 36, 161, 218, 232, 253, 255, 196, 193, 22, 107, 142, 169, 82, 43, 160, 24, 176, 6, 84, 87, 201, 78, 213, 243, 140, 246, 1, 60, 218, 235, 157, 109, 18, 79, 184
    };
    vint8mf4_t *out = &out_data[0];
    int masked[] = {
    0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint8mf4_t out = __riscv_vadd_vv_i8mf4_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8mf4_t golden[] = {
    15, 213, 99, 221, 37, 218, 287, 180, 342, 126, 202, 40, 280, 17, 170, 50, 142, 223, 163, 69, 191, 330, 261, 162, 308, 385, 308, 14, 12, 279, 161, 218, 232, 253, 315, 350, 193, 22, 107, 288, 407, 82, 335, 157, 24, 120, 336, 84, 236, 69, 298, 265, 336, 265, 383, 363, 199, 218, 235, 59, 109, 18, 219, 184
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
