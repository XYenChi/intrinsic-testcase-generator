/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m1_t data1[] = {
    133, 176, 14, 251, 139, 224, 129, 173, 13, 107, 74, 110, 134, 186, 199, 16, 232, 197, 251, 20, 181, 0, 36, 31, 38, 198, 57, 81, 98, 159, 179, 1, 42, 134, 13, 170, 110, 79, 82, 193, 21, 252, 64, 232, 128, 182, 132, 232, 227, 226, 149, 216, 167, 126, 97, 83, 211, 17, 148, 57, 212, 39, 64, 158
    };
    const vint8m1_t *in1 = &data1[0];
    vint8m1_t data2[] = {
    73, 70, 168, 216, 241, 86, 183, 202, 130, 66, 21, 13, 220, 33, 102, 79, 146, 121, 132, 9, 63, 209, 36, 215, 98, 193, 183, 202, 250, 201, 55, 184, 96, 241, 67, 79, 192, 233, 150, 197, 208, 98, 134, 59, 239, 132, 137, 135, 166, 255, 68, 76, 60, 146, 49, 98, 25, 122, 53, 109, 76, 167, 27, 210
    };
    const vint8m1_t *in2 = &data2[0];
    vint8m1_t out_data[] = {
    70, 129, 167, 195, 207, 74, 25, 78, 121, 245, 197, 207, 26, 63, 34, 124, 132, 144, 118, 125, 137, 204, 195, 78, 165, 254, 2, 255, 80, 184, 180, 195, 165, 214, 219, 84, 105, 202, 15, 200, 99, 104, 38, 70, 198, 157, 96, 159, 70, 15, 84, 66, 235, 106, 165, 154, 191, 87, 222, 211, 30, 163, 86, 46
    };
    vint8m1_t *out = &out_data[0];
    int masked[] = {
    0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint8m1_t out = __riscv_vadd_vv_i8m1_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m1_t golden[] = {
    70, 246, 182, 467, 380, 310, 25, 78, 121, 173, 95, 123, 26, 63, 34, 124, 132, 318, 118, 125, 137, 209, 72, 246, 165, 391, 240, 255, 80, 184, 180, 185, 165, 375, 219, 249, 302, 312, 232, 200, 229, 350, 38, 291, 198, 314, 269, 159, 393, 15, 84, 292, 227, 106, 146, 154, 236, 139, 201, 211, 30, 206, 86, 46
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
