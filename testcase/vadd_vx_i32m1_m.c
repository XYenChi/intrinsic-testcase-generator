/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint32m1_t data1[] = {
    180, 124, 62, 5, 231, 25, 229, 107, 70, 201, 159, 7, 191, 187, 201, 113, 231, 254, 218, 64, 11, 249, 93, 57, 230, 172, 179, 206, 108, 166, 218, 27, 22, 108, 13, 77, 23, 10, 205, 120, 225, 142, 129, 192, 63, 130, 248, 138, 84, 28, 107, 156, 185, 113, 180, 70, 243, 128, 76, 131, 186, 221, 47, 44
    };
    const vint32m1_t *in1 = &data1[0];
    vint32m1_t data2[] = {
    52, 220, 13, 255, 130, 83, 51, 42, 247, 36, 95, 200, 176, 243, 255, 184, 62, 112, 132, 181, 105, 61, 30, 223, 47, 74, 89, 55, 211, 47, 203, 10, 11, 227, 188, 232, 2, 234, 216, 212, 49, 62, 128, 136, 74, 55, 128, 247, 217, 242, 250, 58, 226, 219, 192, 142, 250, 27, 141, 206, 45, 30, 115, 228
    };
    const vint32m1_t *in2 = &data2[0];
    vint32m1_t out_data[] = {
    37, 84, 252, 222, 249, 6, 145, 90, 59, 133, 192, 211, 112, 57, 254, 209, 127, 239, 97, 165, 48, 49, 121, 224, 235, 80, 83, 114, 17, 42, 37, 129, 231, 32, 129, 202, 194, 73, 128, 64, 222, 245, 87, 31, 84, 116, 150, 17, 75, 159, 197, 142, 0, 161, 21, 3, 155, 158, 248, 61, 27, 232, 234, 235
    };
    vint32m1_t *out = &out_data[0];
    int masked[] = {
    1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint32m1_t out = __riscv_vadd_vx_i32m1_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint32m1_t golden[] = {
    232, 84, 75, 260, 249, 6, 145, 149, 59, 237, 192, 211, 367, 430, 456, 297, 127, 366, 97, 165, 48, 49, 121, 224, 235, 246, 268, 114, 17, 42, 421, 129, 33, 335, 129, 202, 194, 244, 421, 332, 222, 204, 257, 31, 137, 185, 376, 385, 75, 159, 197, 142, 411, 161, 21, 3, 493, 158, 248, 61, 27, 232, 234, 272
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
