/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint16m8_t data1[] = {
    41923, 31949, 28249, 24745, 8856, 16398, 32034, 35552, 2560, 51377, 16206, 11412, 12698, 35085, 18501, 56606, 64239, 24556, 56703, 12408, 60950, 55450, 45488, 15827, 39998, 19636, 23085, 45773, 32224, 62144, 41390, 64393, 31664, 25463, 38026, 370, 19375, 34297, 27900, 20214, 17749, 61889, 46055, 39672, 10453, 50666, 26166, 5905, 16443, 35307, 36788, 47346, 16708, 58194, 49498, 40492, 54648, 4545, 48024, 19959, 21304, 55949, 62188, 39449
    };
    const vint16m8_t *in1 = &data1[0];
    vint16m8_t data2[] = {
    36872, 14639, 43519, 13638, 2337, 22512, 34130, 13480, 45399, 8339, 12962, 40570, 65325, 63246, 36115, 55873, 48338, 16704, 43471, 43310, 63876, 53335, 7101, 55563, 29157, 46815, 121, 6720, 48952, 15557, 40035, 41048, 3046, 61863, 52182, 55487, 13832, 56132, 13657, 12815, 48133, 42533, 57407, 27514, 37620, 113, 13993, 15207, 34058, 12904, 8233, 26420, 56082, 60285, 13754, 13501, 2935, 44196, 22731, 13967, 34526, 6817, 32113, 18177
    };
    const vint16m8_t *in2 = &data2[0];
    vint16m8_t out_data[] = {
    46715, 52189, 30798, 27247, 11292, 536, 56109, 48688, 15157, 34104, 19165, 63724, 15867, 21650, 19010, 27791, 24006, 16074, 34437, 7660, 10609, 34722, 7512, 33619, 55661, 19749, 58800, 1412, 3301, 10819, 42975, 30099, 337, 62468, 3066, 54063, 35801, 18055, 8434, 54745, 25660, 51649, 2298, 806, 17748, 16171, 3572, 30975, 45743, 6506, 63436, 14567, 47837, 9498, 24615, 19144, 64021, 31619, 36087, 58689, 12101, 8467, 3909, 33943
    };
    vint16m8_t *out = &out_data[0];
    int masked[] = {
    1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 16;n >= 0; n -= Q_element) {
        vint16m8_t out = __riscv_vadd_vv_i16m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint16m8_t golden[] = {
    78795, 52189, 30798, 38383, 11193, 38910, 56109, 48688, 15157, 34104, 19165, 63724, 15867, 98331, 54616, 27791, 112577, 16074, 100174, 55718, 124826, 108785, 52589, 71390, 55661, 19749, 58800, 52493, 81176, 10819, 42975, 105441, 34710, 62468, 3066, 55857, 33207, 90429, 41557, 54745, 65882, 104422, 2298, 806, 48073, 16171, 40159, 30975, 45743, 6506, 63436, 73766, 72790, 9498, 24615, 53993, 57583, 48741, 70755, 58689, 12101, 62766, 3909, 33943
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
