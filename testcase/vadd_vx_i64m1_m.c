/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    14495205257389544427, 1086447396670365740, 9775357127775999600, 18434505129442622366, 3136502455387523431, 12267802257444111652, 13276140475331740772, 11025150423859243929, 5477447086047855314, 9841150349030914716, 13130618084006480023, 13008109646583889783, 11934124581817848447, 16636973265557997813, 12664995608930731535, 13330808057744165503
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    5614519428275455678, 4184756718919207324, 12378619746136271977, 8202954748946561166, 7889213113208197988, 4428945087794953396, 12424070068177570847, 1283675518523717510, 1587930254210017759, 15769454561812088658, 2620801578129955010, 2074382646689079017, 10537041213204525760, 4404951667636399208, 1972125645169776623, 7300205183846788509
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m1(size_t avl);
    const int out_data[] = {
    2415846582054575350, 6258006225057737904, 9514268417838573063, 17632292024547313655, 9569604608500015126, 15114491386680767504, 17483074651180440278, 15735852427205561505, 7747603803112526601, 2888073031217322830, 7983482465363609575, 5317168382912164690, 3339442089142062701, 12204676122166668144, 7006743195990873191, 59874214421854648
    };
    const int64_t *out = &out_data[0];
    bool64_t masked[] = {
    0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0
    };
    const bool64_t *mask = &masked[0];
    vint64m1_t data1_v = __riscv_vle64_v_i64m1_m (mask, *in1, vl);
    vint64m1_t data2_v = __riscv_vle64_v_i64m1_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vadd_vx_i64m1_m (mask, data1_v, data2_v, vl);
        void vint64_t __riscv_vse64m1_v_i64 (vbool64_t mask, int64m1_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    2415846582054575350, 5271204115589573064, 22153976873912271577, 17632292024547313655, 9569604608500015126, 16696747345239065048, 17483074651180440278, 12308825942382961439, 7747603803112526601, 25610604910843003374, 15751419662136435033, 15082492293272968800, 3339442089142062701, 21041924933194397021, 7006743195990873191, 59874214421854648
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
