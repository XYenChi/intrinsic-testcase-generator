/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    4563753013322028599, 3509252764466547148, 13265183929522782891, 3809356028654821169, 16275798061706955427, 16196517490329244833, 2573838643307830923, 6581426887794598474, 8680635276505300333, 3931634295481423867, 8723174973971626950, 2306110097975102975, 12063251033980324177, 13034265705299311660, 17108062336255176327, 6174742409431526015
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    13932531891940947268, 13597643134468137107, 8654619150361159698, 8409707684329560313, 6266872295615972732, 11734672460164336125, 5852904942893636789, 5264723464987352232, 15107363638930815426, 13562148510432076518, 8733870104072353780, 7525347923000318533, 17804448127851552673, 5031082989032553356, 12177211427116894411, 6379953179278772950
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m4(size_t avl);
    const int out_data[] = {
    9570085891531807395, 8519827732526669465, 9889963116584848489, 2288280364950907607, 7961804972017267019, 11367953377604545782, 3029803160690942382, 10046050355080813684, 5642283440835288883, 3289789970345724776, 107494288149656703, 10136625886709175290, 5633774899870223478, 18362956716197589943, 10732176612368626894, 9422005260303874372
    };
    const int64_t *out = &out_data[0];
    bool16_t masked[] = {
    1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1
    };
    const bool16_t *mask = &masked[0];
    vint64m4_t data1_v = __riscv_vle64_v_i64m4_m (mask, *in1, vl);
    vint64m4_t data2_v = __riscv_vle64_v_i64m4_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmax_vx_i64m4_m (mask, data1_v, data2_v, vl);
        void vint16_t __riscv_vse64m4_v_i64 (vbool64_t mask, int64m4_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    13932531891940947268, 13597643134468137107, 13265183929522782891, 2288280364950907607, 16275798061706955427, 16196517490329244833, 3029803160690942382, 6581426887794598474, 5642283440835288883, 13562148510432076518, 8733870104072353780, 10136625886709175290, 17804448127851552673, 13034265705299311660, 10732176612368626894, 6379953179278772950
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
