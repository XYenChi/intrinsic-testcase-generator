/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint8m8_t data1[] = {
    159, 184, 88, 7, 136, 156, 72, 12, 159, 21, 137, 70, 98, 43, 35, 191, 109, 5, 152, 165, 37, 244, 159, 23, 71, 230, 204, 164, 10, 199, 120, 2, 14, 166, 150, 233, 206, 121, 230, 58, 1, 250, 232, 113, 169, 27, 49, 232, 40, 6, 79, 84, 245, 228, 139, 26, 79, 169, 207, 122, 131, 221, 182, 229, 64, 143, 89, 189, 243, 7, 164, 176, 4, 21, 248, 199, 10, 188, 131, 213, 199, 142, 172, 84, 125, 106, 181, 235, 132, 180, 239, 136, 40, 216, 205, 151, 105, 219, 81, 208, 26, 145, 11, 204, 2, 239, 57, 169, 37, 57, 250, 255, 23, 86, 121, 182, 104, 124, 35, 30, 229, 132, 52, 73, 134, 205, 217, 249
    };
    const vint8m8_t *in1 = &data1[0];
    vint8m8_t data2[] = {
    116, 32, 14, 111, 154, 255, 18, 177, 253, 210, 52, 82, 243, 221, 126, 69, 157, 223, 180, 36, 164, 205, 109, 156, 255, 101, 44, 245, 114, 3, 56, 233, 132, 115, 200, 112, 43, 221, 2, 33, 14, 0, 49, 17, 162, 137, 233, 131, 232, 134, 148, 231, 255, 148, 7, 189, 140, 65, 160, 236, 234, 3, 171, 59, 87, 159, 115, 175, 185, 50, 208, 202, 166, 234, 186, 103, 70, 214, 140, 116, 243, 196, 121, 209, 126, 139, 165, 9, 167, 147, 158, 167, 110, 242, 10, 66, 93, 255, 70, 109, 21, 32, 148, 28, 40, 254, 30, 75, 64, 231, 184, 222, 182, 148, 208, 204, 89, 150, 224, 42, 243, 126, 25, 224, 127, 120, 114, 57
    };
    const vint8m8_t *in2 = &data2[0];
    vint8m8_t out_data[] = {
    64, 136, 127, 136, 50, 153, 238, 46, 149, 80, 20, 155, 218, 238, 97, 132, 64, 249, 249, 99, 196, 136, 125, 247, 177, 41, 213, 136, 132, 9, 242, 218, 175, 102, 166, 22, 156, 100, 21, 31, 18, 81, 147, 26, 96, 79, 154, 132, 112, 63, 113, 247, 94, 215, 9, 223, 60, 152, 226, 98, 33, 75, 45, 127, 144, 215, 35, 44, 36, 181, 137, 58, 148, 96, 12, 62, 41, 219, 84, 44, 3, 166, 197, 20, 69, 159, 22, 148, 188, 0, 58, 15, 0, 248, 9, 125, 8, 99, 4, 113, 37, 122, 104, 174, 215, 136, 108, 33, 63, 96, 212, 103, 145, 40, 184, 242, 206, 181, 150, 253, 210, 119, 134, 17, 214, 175, 39, 231
    };
    vint8m8_t *out = &out_data[0];
    int masked[] = {
    0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 128, Q_element = 8;n >= 0; n -= Q_element) {
        vint8m8_t out = __riscv_vadd_vv_i8m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint8m8_t golden[] = {
    64, 216, 102, 118, 50, 153, 90, 189, 149, 231, 20, 152, 218, 264, 161, 132, 64, 249, 249, 99, 201, 449, 268, 247, 326, 41, 248, 136, 132, 202, 242, 235, 146, 281, 166, 345, 156, 100, 21, 31, 18, 250, 281, 130, 331, 79, 154, 363, 272, 140, 227, 315, 500, 215, 146, 215, 219, 152, 367, 98, 365, 224, 45, 127, 151, 215, 35, 364, 428, 57, 137, 58, 148, 255, 434, 302, 41, 402, 271, 44, 442, 338, 293, 293, 69, 245, 22, 148, 299, 0, 58, 303, 0, 248, 215, 125, 8, 474, 4, 113, 47, 177, 104, 232, 215, 493, 87, 33, 63, 288, 212, 103, 145, 234, 184, 386, 206, 274, 259, 72, 210, 119, 134, 297, 214, 175, 39, 231
    };
    int fail = 0;
    for (int i = 0; i < 128; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
