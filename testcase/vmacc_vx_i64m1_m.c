/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    10645620573114760922, 13606249121585356379, 17461853040354929902, 11642668984905235859, 7390396267847794364, 3792825922604417475, 7072466991982973163, 17410221319820703579, 13578653224093895401, 2244142566219977254, 17415310337555968125, 13942883150016192358, 1843381560963733455, 3253275111977357894, 1899462308055253011, 1352638757770157428
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    5300242551365331495, 1809578452530735318, 5748449284917582258, 15952413485024073492, 10269307217968252365, 10597931149596420888, 18410454997152776712, 9462631472065962124, 14422752686650569224, 7524108550933517281, 9026818911331007207, 4492110307188415425, 10615753221708324685, 9649908861853621243, 393347970645762261, 15312520245561000576
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m1(size_t avl);
    const int out_data[] = {
    907809557791680297, 8617276796175038748, 17246242066239017041, 12866961534778569542, 3230745963595470920, 4509815099431470003, 5103037698069464625, 4161246803198724216, 3469514819416980483, 10210468757652826012, 7633330786509048095, 4569681858721321654, 1155909664049920094, 9643763599087347278, 286569298969162038, 10461399492698718419
    };
    const int64_t *out = &out_data[0];
    bool64_t masked[] = {
    1, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1
    };
    const bool64_t *mask = &masked[0];
    vint64m1_t data1_v = __riscv_vle64_v_i64m1_m (mask, *in1, vl);
    vint64m1_t data2_v = __riscv_vle64_v_i64m1_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmacc_vx_i64m1_m (mask, data1_v, data2_v, vl);
        void vint64_t __riscv_vse64m1_v_i64 (vbool64_t mask, int64m1_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    9664196104897325279834535695812953835, 117248814838414495069365682239713973493, 301151344459052868090436146466938459982, 149805773990935123892185722102143606578, 23876492911720294404727045061901894881, 17104943615276497945059060800751502426, 36091065678441062092334274011152858875, 72448227810086175883492262516305169065, 47111338588717931321077627160660458684, 22913747560107915983082486943459531048, 132936824556275254037763868779911971876, 63714540188900190159889251162454720132, 2130782560849406434955785424664544771, 31373816102704057695968867915672712533, 544327582037740362153669102746396419, 14150494414341349584346514939473266333
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
