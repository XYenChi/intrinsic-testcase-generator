/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2 -w" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    3050485405859985996, -6633774242616351857, -1662250249130361022, 1564374053444896088, 7972994284179868852, 8884417781129557387, -7206611155487202754, -2860150887413764453, -4355720824196394748, 689013072693365872, 8480410718021961515, 3888090874039627335, 7591395618757415307, 3554097297403791005, -436165824319038825, 4792592426715636232
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    8909091938620313486, -6456406144506414080, 5025040185503497118, 8088700998758264165, 7612688162763150904, 2524239236600774225, -6204141104679681893, -5748160965797322024, 279561252005443223, 9010188418296096546, 2131759286668528287, -4221028138402960587, -7259179964280107612, 4867150969315674944, -6809872808845218295, 1075415131350309534
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = __riscv_vsetvl_e64m8(avl);
    const int out_data[] = {
    5446543468349488503, 7481953441110799603, 2851552152390428322, -396239287320156824, -658061266675779897, -677520236432949679, -499189797515871667, 219244536902512275, -4090572019355527118, 716428879602583470, -8417636333055927847, -1468367975479979035, 2491082889789023271, 1290238139184695313, 7941148593744976948, 8201260312281959313
    };
    const int64_t *out = &out_data[0];
    bool8_t masked[] = {
    0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1
    };
    const bool8_t *mask = &masked[0];
    vint64m8_t data1_v = __riscv_vle64_v_i64m8_m (mask, *in1, vl);
    vint64m8_t data2_v = __riscv_vle64_v_i64m8_m (mask, *in2, vl);
    vint64m8_t data1_v = __riscv_vle64_v_i64m8_m (mask, *out, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vadd_vx_i64m8_m (mask, data1_v, data2_v, vl);
        void __riscv_vse64_v_i64m8 (bool64_t mask, int64_t *out, vint64m8_t out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    5446543468349488503, 7481953441110799604, 2851552152390428323, -396239287320156824, -658061266675779897, -677520236432949678, -499189797515871667, 219244536902512275, -4090572019355527118, 716428879602583471, -8417636333055927846, -1468367975479979034, 2491082889789023272, 1290238139184695313, 7941148593744976948, 8201260312281959314
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out_data[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
