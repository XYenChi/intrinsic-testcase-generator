/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint64m8_t data1[] = {
    2542618282615907559, 9618131077144805134, 9195006942926033729, 7384468707486800771, 5959808868374866416, 15398066555534435641, 16080475011121506412, 2682260656297136849, 15592104987499171416, 13688641479332751584, 6050157923699300924, 8125727225084289786, 6353507964018498551, 10334269502060474938, 10953003228902741256, 4790451700640912452
    };
    const vint64m8_t *in1 = &data1[0];
    vint64m8_t data2[] = {
    778730742708218691, 123847180386232329, 12498557299158296764, 14326316055819095461, 103949587821454171, 14017642286033803177, 15544554365153220496, 10794475496506050682, 2505770414366747932, 5852220771236220210, 16479969227627727085, 7181111805199634071, 948204743017523735, 13329406459145963384, 4148752014624189959, 7311762467078155942
    };
    const vint64m8_t *in2 = &data2[0];
    vint64m8_t out_data[] = {
    2733428598363388134, 14186521991898992634, 3731542093900290538, 2015729406016467259, 1007537678743299662, 8430077818334400600, 9435887530307398147, 5533346074669824213, 12502927789294403437, 9084731411406340348, 8571753055116160092, 10649327586085096144, 4946248843790454089, 14486637687284828539, 3172070520838559416, 474724084433199830
    };
    vint64m8_t *out = &out_data[0];
    int masked[] = {
    0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0
    };
    const int *mask = &masked[0];
    for (int n = 16, Q_element = 64;n >= 0; n -= Q_element) {
        vint64m8_t out = __riscv_vadd_vx_i64m8_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint64m8_t golden[] = {
    2733428598363388134, 9741978257531037463, 21693564242084330493, 21710784763305896232, 6063758456196320587, 29415708841568238818, 9435887530307398147, 13476736152803187531, 12502927789294403437, 9084731411406340348, 22530127151327028009, 10649327586085096144, 4946248843790454089, 14486637687284828539, 3172070520838559416, 474724084433199830
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
