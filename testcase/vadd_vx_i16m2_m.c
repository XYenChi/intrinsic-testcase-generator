/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint16m2_t data1[] = {
    184, 139, 207, 63, 249, 14, 20, 13, 194, 203, 16, 123, 37, 31, 174, 199, 73, 30, 21, 248, 107, 108, 246, 83, 123, 73, 237, 54, 53, 173, 244, 177, 247, 159, 65, 244, 234, 218, 6, 64, 155, 180, 123, 28, 32, 53, 200, 254, 35, 141, 7, 31, 223, 143, 210, 88, 135, 239, 215, 6, 35, 58, 43, 121
    };
    const vint16m2_t *in1 = &data1[0];
    vint16m2_t data2[] = {
    33, 124, 135, 69, 120, 144, 208, 26, 114, 105, 110, 198, 167, 94, 46, 44, 88, 117, 117, 194, 120, 108, 173, 44, 197, 39, 159, 15, 51, 136, 189, 41, 170, 176, 194, 206, 173, 41, 197, 133, 116, 227, 120, 165, 220, 161, 179, 175, 50, 85, 181, 23, 238, 69, 47, 160, 178, 189, 4, 239, 174, 236, 170, 176
    };
    const vint16m2_t *in2 = &data2[0];
    vint16m2_t out_data[] = {
    189, 103, 189, 218, 72, 185, 73, 12, 103, 104, 145, 234, 11, 252, 100, 155, 254, 187, 250, 235, 8, 87, 71, 28, 169, 188, 84, 46, 211, 235, 124, 173, 110, 235, 98, 76, 232, 1, 151, 3, 43, 28, 127, 60, 174, 204, 41, 191, 196, 227, 226, 31, 108, 184, 214, 214, 0, 42, 96, 220, 209, 92, 110, 22
    };
    vint16m2_t *out = &out_data[0];
    int masked[] = {
    1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint16m2_t out = __riscv_vadd_vx_i16m2_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint16m2_t golden[] = {
    217, 263, 342, 218, 72, 185, 228, 39, 308, 308, 145, 234, 204, 252, 100, 155, 161, 147, 138, 442, 8, 216, 419, 28, 169, 188, 396, 69, 104, 235, 433, 218, 417, 335, 98, 450, 232, 1, 151, 3, 43, 28, 243, 193, 252, 204, 41, 191, 85, 227, 188, 54, 108, 184, 257, 248, 313, 428, 96, 245, 209, 294, 213, 297
    };
    int fail = 0;
    for (int i = 0; i < 64; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
