/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint32m4_t data1[] = {
    128, 165, 68, 241, 141, 121, 87, 80, 154, 212, 113, 153, 158, 151, 254, 150, 161, 167, 102, 79, 121, 153, 219, 24, 4, 179, 93, 75, 86, 228, 174, 227, 41, 222, 136, 192, 243, 157, 103, 1, 157, 148, 117, 109, 147, 251, 237, 51, 157, 172, 211, 253, 207, 219, 139, 37, 154, 96, 213, 78, 232, 156, 130, 124
    };
    const vint32m4_t *in1 = &data1[0];
    vint32m4_t data2[] = {
    200, 176, 33, 105, 12, 155, 77, 215, 190, 25, 32, 152, 195, 147, 215, 58, 4, 134, 68, 56, 188, 185, 227, 203, 67, 192, 39, 174, 186, 155, 117, 76, 140, 192, 134, 183, 109, 24, 22, 218, 195, 24, 184, 179, 155, 241, 177, 77, 135, 65, 131, 123, 163, 52, 131, 13, 7, 52, 252, 122, 74, 127, 242, 185
    };
    const vint32m4_t *in2 = &data2[0];
    vint32m4_t out_data[] = {
    34, 67, 65, 242, 178, 208, 82, 3, 204, 216, 225, 218, 189, 45, 23, 129, 61, 43, 14, 64, 87, 136, 71, 177, 178, 202, 57, 48, 228, 39, 176, 29, 161, 58, 171, 222, 157, 55, 90, 104, 13, 56, 133, 201, 114, 119, 203, 236, 108, 252, 96, 81, 40, 127, 170, 114, 134, 250, 119, 30, 98, 171, 237, 98
    };
    vint32m4_t *out = &out_data[0];
    int masked[] = {
    0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 64, Q_element = 4;n >= 0; n -= Q_element) {
        vint32m4_t out = __riscv_vadd_vx_i32m4_m (, mask, data1, data264);
)        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint32m4_t golden[] = {
    34, 341, 65, 242, 153, 208, 164, 3, 204, 216, 225, 218, 189, 298, 469, 208, 165, 301, 170, 64, 309, 136, 446, 177, 178, 202, 132, 48, 228, 383, 176, 303, 161, 414, 171, 375, 352, 181, 90, 104, 13, 172, 133, 201, 302, 492, 414, 236, 108, 237, 96, 81, 40, 127, 270, 50, 134, 148, 465, 30, 306, 283, 372, 98
    };
    int fail = 0;
    for (int i = 0; i < 64; i++)
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
