/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    vint16m4_t data1[] = {
    44518, 4396, 45226, 17096, 7129, 45981, 7082, 58441, 34037, 24030, 9647, 65290, 41478, 46879, 23312, 7754, 64306, 37969, 59757, 9794, 53249, 53716, 27272, 10626, 64031, 49638, 57046, 2210, 55126, 56403, 17553, 43949
    };
    const vint16m4_t *in1 = &data1[0];
    vint16m4_t data2[] = {
    51248, 6809, 48243, 22774, 49038, 15062, 4486, 20221, 34162, 38374, 39299, 54442, 58837, 41219, 31715, 40673, 12599, 60142, 31481, 21649, 43688, 17107, 8316, 55287, 55450, 37129, 9372, 48512, 60234, 50697, 45255, 55226
    };
    const vint16m4_t *in2 = &data2[0];
    vint16m4_t out_data[] = {
    42758, 26724, 48035, 42487, 39990, 15982, 4984, 51888, 6816, 41128, 2993, 57507, 41840, 16776, 53317, 31921, 4248, 14672, 35230, 41599, 762, 11410, 45522, 15938, 30316, 33345, 47815, 59207, 36192, 8246, 15267, 6203
    };
    vint16m4_t *out = &out_data[0];
    int masked[] = {
    1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0
    };
    const int *mask = &masked[0];
    for (int n = 32, Q_element = 16;n >= 0; n -= Q_element) {
        vint16m4_t out = __riscv_vadd_vx_i16m4_m (, mask, data1, data264);
        in1 += Q_element;
        in2 += Q_element;
        out += Q_element;
        mask += Q_element;
      }
    vint16m4_t golden[] = {
    95766, 26724, 93469, 39870, 39990, 61043, 11568, 51888, 6816, 41128, 2993, 57507, 100315, 16776, 55027, 48427, 4248, 14672, 91238, 41599, 96937, 70823, 45522, 65913, 119481, 86767, 66418, 59207, 115360, 107100, 62808, 6203
    };
    int fail = 0;
    for (int i = 0; i < 32; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
