/* { dg-do run } */
/* { dg-options "-march=rv64gcv -mabi=lp64d -O3 -fno-schedule-insns -fno-schedule-insns2" } */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "riscv_vector.h"
int main(){
    const int64_t data1[] = {
    14562857196487197630, 18060979779285732066, 17167478343862564380, 4632024080461037131, 16164117668994434615, 11038183060191928439, 1490677808852723829, 1879777202717684758, 7856258015208558118, 11925384431565737443, 2050969943480706273, 13565002222023426305, 1163381489643961764, 10146000163643461148, 12485027690777945942, 16454916810080905259
    };
    const int64_t *in1 = &data1[0];
    const int64_t data2[] = {
    1341100269326345553, 6961299256389997758, 8679609148425567522, 15223204216263660264, 2353304001483892415, 16432305188258550965, 11053357968840041139, 4175822551040752302, 13440559693804822186, 16583575027394581518, 2957591813971969994, 15790675891515214757, 15670110976980067703, 307154067345437152, 8025332770609162951, 11984081760877530228
    };
    const int64_t *in2 = &data2[0];
    size_t avl = 64;
    size_t vl = vsetvl_e64m1(size_t avl);
    const int out_data[] = {
    10600449600152507378, 18245925262438695787, 15291119003297224071, 8325422765904870695, 14479152675995668774, 15547907219459574619, 203127108083598079, 12360934700755615399, 9079089731677878913, 3249087165724646821, 6350053439476017776, 6860129810404602433, 14721270565582353974, 10686546882878451071, 7891483616579216116, 1115727636993225178
    };
    const int64_t *out = &out_data[0];
    bool64_t masked[] = {
    1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1
    };
    const bool64_t *mask = &masked[0];
    vint64m1_t data1_v = __riscv_vle64_v_i64m1_m (mask, *in1, vl);
    vint64m1_t data2_v = __riscv_vle64_v_i64m1_m (mask, *in2, vl);
    for (size_t n = 0; n < vl; n++) {
        out_v = __riscv_vmul_vv_i64m1_m (mask, data1_v, data2_v, vl);
        void vint64_t __riscv_vse64m1_v_i64 (vbool64_t mask, int64m1_t *out, out_v, size_t vl);
        in1 += 8;
        in2 += 8;
        out += 8;
        mask += 8;
      }
    int64_t golden[] = {
    19530251708370090281696806637982639390, 125727885107216552463665913243128708028, 149007002088787324665173203671762066360, 70514248511509264368280458587673262584, 14479152675995668774, 181382792768939474845963717715114393635, 203127108083598079, 7849616034040811747223243967998812916, 105592504823343217979018910764436805948, 197765507451393690260314411758048378474, 6350053439476017776, 6860129810404602433, 18230317051285268194448797557863308092, 10686546882878451071, 100196501868763092673052128375747194842, 197197068420447647738741305330376669052
    };
    int fail = 0;
    for (int i = 0; i < 16; i++){
        if (golden[i] != out_data[i]) {
            printf ("idx=%d golden=%d out=%d\n", i, golden[i], out[i]);
            fail++;
            }
        }
    if (fail) {
        return 1;
    } else {
        return 0;
    }
}
